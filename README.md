# sumologic-otel-collector

[![Default branch build](https://github.com/SumoLogic/sumologic-otel-collector/actions/workflows/dev_builds.yml/badge.svg)](https://github.com/SumoLogic/sumologic-otel-collector/actions/workflows/dev_builds.yml)

Sumo Logic Distro of [OpenTelemetry Collector][otc_link] built with
[opentelemetry-collector-builder][otc_builder_link].

[otc_link]: https://github.com/open-telemetry/opentelemetry-collector
[otc_builder_link]: https://github.com/open-telemetry/opentelemetry-collector-builder

---

- [Configuration](#configuration)
- [How to run](#how-to-run)
  - [Binary](#binary)
  - [Docker container](#docker-container)
- [How to build](#how-to-build)

---

## Configuration

In order to send data to [Sumo Logic][sumologic_webpage] one needs to configure
the [sumologicextension][sumologicextension] with credentials and define it
(the extension) in the same service as [sumologicexporter][sumologicexporter]
is defined so that it's used as auth extension.

```yaml
extensions:
  sumologic:
    access_id: <my_access_id>
    access_key: <my_access_key>
    collector_name: <my_collector_name>

# Define your receivers...
receivers:
  hostmetrics:
    collection_interval: 30s
    scrapers:
      load:

# Define your processors...
processors:

exporters:
  sumologic:
    auth:
      authenticator: sumologic

service:
  extensions: [sumologic]
  pipelines:
    metrics:
      receivers: [hostmetrics]
      processors: []
      exporters: [sumologic]
```

For a list of all configuration options for sumologicextension please refer to
[the documentation][sumologicextension_configuration].

[sumologic_webpage]: https://www.sumologic.com/
[sumologicexporter]: ./pkg/exporter/sumologicexporter/
[sumologicextension]: ./pkg/extension/sumologicextension/
[sumologicextension_configuration]: ./pkg/extension/sumologicextension#configuration

## How to run

```bash
Usage:
  otelcol-sumo [flags]

Flags:
      --add-instance-id             Flag to control the addition of 'service.instance.id' to the collector metrics. (default true)
      --config string               Path to the config file
  -h, --help                        help for otelcol-sumo
      --log-format string           Format of logs to use (json, console) (default "console")
      --log-level Level             Output level of logs (DEBUG, INFO, WARN, ERROR, DPANIC, PANIC, FATAL) (default info)
      --log-profile string          Logging profile to use (dev, prod) (default "prod")
      --mem-ballast-size-mib uint   Flag to specify size of memory (MiB) ballast to set. Ballast is not used when this is not specified. default settings: 0
      --metrics-addr string         [address]:port for exposing collector telemetry. (default ":8888")
      --metrics-level Level         Output level of telemetry metrics (none, basic, normal, detailed) (default basic)
      --metrics-prefix string       Prefix to the metrics generated by the collector. (default "otelcol")
      --set stringArray             Set arbitrary component config property. The component has to be defined in the config file and the flag has a higher precedence. Array config properties are overridden and maps are joined, note that only a single (first) array property can be set e.g. -set=processors.attributes.actions.key=some_key. Example --set=processors.batch.timeout=2s (default [])
  -v, --version                     version for otelcol-sumo
```

### Binary

Visit [releases page][releases_page] in order to download the binary for your OS
and then run it as shown below:

```bash
$ curl -sLo otelcol-sumo https://github.com/SumoLogic/sumologic-otel-collector/releases/download/v0.0.5/otelcol-sumo-0.0.5-darwin_amd64
$ chmod +x otelcol-sumo
$ ./otelcol-sumo --version
otelcol-sumo-darwin_amd64 version v0.0.5
```

[releases_page]: https://github.com/SumoLogic/sumologic-otel-collector/releases

### Docker container

Our container images are stored in AWS Public ECR under the following repository:
`public.ecr.aws/sumologic/sumologic-otel-collector`.

One can find all the available tags pushed to this repository at
https://gallery.ecr.aws/sumologic/sumologic-otel-collector.

In order to run Sumo Logic OT distro in a container one can use the following
set of commands:

```bash
$ ls config.yaml
config.yaml
$ docker run --rm -ti --name sumologic-otel-collector -v $(pwd)/config.yaml:/etc/config.yaml public.ecr.aws/sumologic/sumologic-otel-collector:0.0.4 --config /etc/config.yaml
2021-06-26T16:56:29.173Z        info    service/application.go:277      Starting otelcol-sumo-linux_amd64...    {"Version": "v0.0.4", "NumCPU": 8}
2021-06-26T16:56:29.174Z        info    service/application.go:185      Setting up own telemetry...
2021-06-26T16:56:29.175Z        info    service/telemetry.go:98 Serving Prometheus metrics      {"address": ":8888", "level": 0, "service.instance.id": "ad048e2f-f5b9-490f-b118-5c3ae84a9c90"}
2021-06-26T16:56:29.175Z        info    service/application.go:220      Loading configuration...
2021-06-26T16:56:29.177Z        info    service/application.go:236      Applying configuration...
2021-06-26T16:56:29.177Z        info    builder/exporters_builder.go:274        Exporter was built.     {"kind": "exporter", "exporter": "sumologic"}
2021-06-26T16:56:29.177Z        info    builder/pipelines_builder.go:204        Pipeline was built.     {"pipeline_name": "logs", "pipeline_datatype": "logs"}
2021-06-26T16:56:29.178Z        info    builder/pipelines_builder.go:204        Pipeline was built.     {"pipeline_name": "metrics", "pipeline_datatype": "metrics"}
2021-06-26T16:56:29.178Z        info    builder/receivers_builder.go:230        Receiver was built.     {"kind": "receiver", "name": "hostmetrics", "datatype": "metrics"}
2021-06-26T16:56:29.178Z        info    builder/receivers_builder.go:230        Receiver was built.     {"kind": "receiver", "name": "filelog", "datatype": "logs"}
2021-06-26T16:56:29.178Z        info    service/service.go:155  Starting extensions...
2021-06-26T16:56:29.178Z        info    builder/extensions_builder.go:53        Extension is starting...        {"kind": "extension", "name": "sumologic"}
2021-06-26T16:56:29.178Z        info    sumologicextension@v0.27.0/extension.go:90      Locally stored credentials not found, registering the collector {"kind": "extension", "name": "sumologic"}
2021-06-26T16:56:29.178Z        info    sumologicextension@v0.27.0/credentials.go:135   Calling register API    {"kind": "extension", "name": "sumologic", "URL": "https://collectors.sumologic.com/api/v1/collector/register"}
...
```

## How to build

```
$ cd otelcolbuilder && make build
opentelemetry-collector-builder \
                --config .otelcol-builder.yaml \
                --output-path ./cmd \
                --name otelcol-sumo
2021-05-24T16:29:03.494+0200    INFO    cmd/root.go:99  OpenTelemetry Collector distribution builder    {"version": "dev", "date": "unknown"}
2021-05-24T16:29:03.498+0200    INFO    builder/main.go:90      Sources created {"path": "./cmd"}
2021-05-24T16:29:03.612+0200    INFO    builder/main.go:126     Getting go modules
2021-05-24T16:29:03.957+0200    INFO    builder/main.go:107     Compiling
2021-05-24T16:29:09.770+0200    INFO    builder/main.go:113     Compiled        {"binary": "./cmd/otelcol-sumo"}
```

In order to build for a different platform one can use `otelcol-sumo-${platform}_${arch}`
make targets e.g.:

```
$ cd otelcolbuilder && make otelcol-sumo-linux_arm64
GOOS=linux   GOARCH=arm64 /Library/Developer/CommandLineTools/usr/bin/make build BINARY_NAME=otelcol-sumo-linux_arm64
opentelemetry-collector-builder \
                --config .otelcol-builder.yaml \
                --output-path ./cmd \
                --name otelcol-sumo-linux_arm64
2021-05-24T16:32:11.963+0200    INFO    cmd/root.go:99  OpenTelemetry Collector distribution builder    {"version": "dev", "date": "unknown"}
2021-05-24T16:32:11.965+0200    INFO    builder/main.go:90      Sources created {"path": "./cmd"}
2021-05-24T16:32:12.066+0200    INFO    builder/main.go:126     Getting go modules
2021-05-24T16:32:12.376+0200    INFO    builder/main.go:107     Compiling
2021-05-24T16:32:37.326+0200    INFO    builder/main.go:113     Compiled        {"binary": "./cmd/otelcol-sumo-linux_arm64"}
```
