name: "Drafting Release"

run-name: >
  ${{ format('Drafting Release for Build: {0}', inputs.package_build_number) }}

on:
  workflow_dispatch:
    inputs:
      package_build_number:
        description: |
          Package build number validated by QE (e.g., 1790 from version 0.108.0-1790).
        required: true
        type: string

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: bash

jobs:
  validate-and-discover:
    name: Validate & Discover Workflows
    runs-on: ubuntu-24.04
    outputs:
      collector-workflow-id: ${{ steps.find-workflows.outputs.collector-workflow-id }}
      packaging-workflow-id: ${{ steps.find-workflows.outputs.packaging-workflow-id }}
      containers-workflow-id: ${{ steps.find-workflows.outputs.containers-workflow-id }}
      package-version: ${{ steps.find-workflows.outputs.package-version }}
      collector-version: ${{ steps.find-workflows.outputs.collector-version }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Find all workflow IDs
        id: find-workflows
        run: |
          set -euo pipefail
          
          BUILD_NUMBER="${{ inputs.package_build_number }}"
          
          # Step 1: Find packaging workflow by build number
          PKG_RESULT=$(gh run list -R SumoLogic/sumologic-otel-collector-packaging \
            -w build_packages.yml -s success -b main -L 200 \
            --json databaseId,displayTitle,number,url \
            -q ".[] | select(.number == ${BUILD_NUMBER})")
          
          if [[ -z "$PKG_RESULT" ]]; then
            echo "::error::Packaging workflow not found for build: ${BUILD_NUMBER}"
            exit 1
          fi
          
          PKG_WORKFLOW_ID=$(echo "$PKG_RESULT" | jq -r '.databaseId')
          PKG_DISPLAY_TITLE=$(echo "$PKG_RESULT" | jq -r '.displayTitle')
          echo "packaging-workflow-id=${PKG_WORKFLOW_ID}" >> "$GITHUB_OUTPUT"
          
          # Step 2: Extract collector workflow ID from packaging displayTitle
          COLLECTOR_WORKFLOW_ID=$(echo "$PKG_DISPLAY_TITLE" | grep -oP 'Build for Remote Workflow: \K\d+' || true)
          
          if [[ -z "$COLLECTOR_WORKFLOW_ID" ]]; then
            echo "::error::Could not extract collector workflow ID from: ${PKG_DISPLAY_TITLE}"
            exit 1
          fi
          
          echo "collector-workflow-id=${COLLECTOR_WORKFLOW_ID}" >> "$GITHUB_OUTPUT"
          
          # Verify collector workflow exists and is successful
          COLLECTOR_RESULT=$(gh run view "${COLLECTOR_WORKFLOW_ID}" \
            -R SumoLogic/sumologic-otel-collector --json status,conclusion)
          COLLECTOR_STATUS=$(echo "$COLLECTOR_RESULT" | jq -r '.status')
          COLLECTOR_CONCLUSION=$(echo "$COLLECTOR_RESULT" | jq -r '.conclusion')
          
          if [[ "$COLLECTOR_STATUS" != "completed" ]] || [[ "$COLLECTOR_CONCLUSION" != "success" ]]; then
            echo "::error::Collector workflow not successful (status: ${COLLECTOR_STATUS}, conclusion: ${COLLECTOR_CONCLUSION})"
            exit 1
          fi
          
          # Step 3: Find containers workflow by collector workflow ID
          CONTAINERS_RESULT=$(gh run list -R SumoLogic/sumologic-otel-collector-containers \
            -w build-and-push.yml -s success -b main -L 200 \
            --json databaseId,displayTitle \
            -q ".[] | select(.displayTitle | contains(\"${COLLECTOR_WORKFLOW_ID}\"))")
          
          if [[ -z "$CONTAINERS_RESULT" ]]; then
            echo "::error::Containers workflow not found for collector workflow: ${COLLECTOR_WORKFLOW_ID}"
            exit 1
          fi
          
          CONTAINERS_WORKFLOW_ID=$(echo "$CONTAINERS_RESULT" | jq -r '.databaseId')
          echo "containers-workflow-id=${CONTAINERS_WORKFLOW_ID}" >> "$GITHUB_OUTPUT"
          
          # Step 4: Get version information
          gh run download "${PKG_WORKFLOW_ID}" -R SumoLogic/sumologic-otel-collector-packaging \
            -n "otc-version.txt" -D /tmp/versions 2>/dev/null || true
          gh run download "${PKG_WORKFLOW_ID}" -R SumoLogic/sumologic-otel-collector-packaging \
            -n "otc-build-number.txt" -D /tmp/versions 2>/dev/null || true
          gh run download "${PKG_WORKFLOW_ID}" -R SumoLogic/sumologic-otel-collector-packaging \
            -n "otc-sumo-version.txt" -D /tmp/versions 2>/dev/null || true
          
          if [[ -f "/tmp/versions/otc-version.txt" && -f "/tmp/versions/otc-build-number.txt" && -f "/tmp/versions/otc-sumo-version.txt" ]]; then
            OTC_VERSION=$(cat /tmp/versions/otc-version.txt)
            OTC_BUILD=$(cat /tmp/versions/otc-build-number.txt)
            OTC_SUMO=$(cat /tmp/versions/otc-sumo-version.txt)
            
            echo "package-version=${OTC_VERSION}-${OTC_BUILD}" >> "$GITHUB_OUTPUT"
            echo "collector-version=${OTC_VERSION}-sumo-${OTC_SUMO}" >> "$GITHUB_OUTPUT"
            
            echo "::notice::Package Version: ${OTC_VERSION}-${OTC_BUILD}"
            echo "::notice::Collector Version: ${OTC_VERSION}-sumo-${OTC_SUMO}"
          else
            echo "::warning::Could not download version artifacts"
          fi

  release-collector:
    name: Release Collector (Draft)
    runs-on: ubuntu-24.04
    needs: validate-and-discover
    outputs:
      release-run-id: ${{ steps.trigger.outputs.release-run-id }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Trigger collector release workflow
        id: trigger
        run: |
          set -euo pipefail
          
          WORKFLOW_ID="${{ needs.validate-and-discover.outputs.collector-workflow-id }}"
          REPO="SumoLogic/sumologic-otel-collector"
          
          gh workflow run releases.yml -R "${REPO}" -f "workflow_id=${WORKFLOW_ID}"
          sleep 5
          
          RELEASE_RUN=$(gh run list -R "${REPO}" -w releases.yml -L 10 \
            --json databaseId,displayTitle \
            -q ".[] | select(.displayTitle | contains(\"${WORKFLOW_ID}\")) | .databaseId" | head -n 1)
          
          if [[ -z "$RELEASE_RUN" ]]; then
            echo "::error::Could not find triggered release workflow"
            exit 1
          fi
          
          echo "release-run-id=${RELEASE_RUN}" >> "$GITHUB_OUTPUT"
          gh run watch "${RELEASE_RUN}" -R "${REPO}" --exit-status

  promote-packaging-to-stable:
    name: Promote Packaging RCâ†’Stable
    runs-on: ubuntu-24.04
    needs: 
      - validate-and-discover
      - release-collector
    outputs:
      promote-run-id: ${{ steps.promote.outputs.promote-run-id }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Promote release-candidates to stable
        id: promote
        run: |
          set -euo pipefail
          
          VERSION="${{ needs.validate-and-discover.outputs.package-version }}"
          REPO="SumoLogic/sumologic-otel-collector-packaging"
          
          gh workflow run promote-release-candidate.yml -R "${REPO}" -f "version=${VERSION}"
          sleep 5
          
          PROMOTE_RUN=$(gh run list -R "${REPO}" -w promote-release-candidate.yml -L 10 \
            --json databaseId,displayTitle \
            -q ".[] | select(.displayTitle | contains(\"${VERSION}\")) | .databaseId" | head -n 1)
          
          if [[ -z "$PROMOTE_RUN" ]]; then
            echo "::warning::Could not find promotion workflow, it may take longer to appear"
          else
            echo "promote-run-id=${PROMOTE_RUN}" >> "$GITHUB_OUTPUT"
            gh run watch "${PROMOTE_RUN}" -R "${REPO}" --exit-status
          fi

  release-packaging:
    name: Create Packaging Draft Release
    runs-on: ubuntu-24.04
    needs: 
      - validate-and-discover
      - promote-packaging-to-stable
    outputs:
      release-run-id: ${{ steps.release.outputs.release-run-id }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Trigger packaging release workflow
        id: release
        run: |
          set -euo pipefail
          
          WORKFLOW_ID="${{ needs.validate-and-discover.outputs.packaging-workflow-id }}"
          REPO="SumoLogic/sumologic-otel-collector-packaging"
          
          gh workflow run releases.yml -R "${REPO}" -f "workflow_id=${WORKFLOW_ID}"
          sleep 5
          
          RELEASE_RUN=$(gh run list -R "${REPO}" -w releases.yml -L 10 \
            --json databaseId,displayTitle \
            -q ".[] | select(.displayTitle | contains(\"${WORKFLOW_ID}\")) | .databaseId" | head -n 1)
          
          if [[ -z "$RELEASE_RUN" ]]; then
            echo "::error::Could not find triggered release workflow"
            exit 1
          fi
          
          echo "release-run-id=${RELEASE_RUN}" >> "$GITHUB_OUTPUT"
          gh run watch "${RELEASE_RUN}" -R "${REPO}" --exit-status

  release-containers:
    name: Release Containers RCâ†’Stable + Draft
    runs-on: ubuntu-24.04
    needs:
      - validate-and-discover
      - promote-packaging-to-stable
    outputs:
      release-run-id: ${{ steps.release.outputs.release-run-id }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Trigger containers release workflow
        id: release
        run: |
          set -euo pipefail
          
          WORKFLOW_ID="${{ needs.validate-and-discover.outputs.containers-workflow-id }}"
          REPO="SumoLogic/sumologic-otel-collector-containers"
          
          gh workflow run releases.yml -R "${REPO}" -f "workflow-id=${WORKFLOW_ID}"
          sleep 5
          
          RELEASE_RUN=$(gh run list -R "${REPO}" -w releases.yml -L 10 \
            --json databaseId,displayTitle \
            -q ".[] | select(.displayTitle | contains(\"${WORKFLOW_ID}\")) | .databaseId" | head -n 1)
          
          if [[ -z "$RELEASE_RUN" ]]; then
            echo "::error::Could not find triggered release workflow"
            exit 1
          fi
          
          echo "release-run-id=${RELEASE_RUN}" >> "$GITHUB_OUTPUT"
          gh run watch "${RELEASE_RUN}" -R "${REPO}" --exit-status

  release-summary:
    name: Release Summary
    runs-on: ubuntu-24.04
    needs:
      - validate-and-discover
      - release-collector
      - promote-packaging-to-stable
      - release-packaging
      - release-containers
    if: always()
    steps:
      - name: Generate summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          
          **Build Number**: ${{ inputs.package_build_number }}
          **Package Version**: ${{ needs.validate-and-discover.outputs.package-version }}
          **Collector Version**: ${{ needs.validate-and-discover.outputs.collector-version }}
   
          ### Collector
          - **Status**: ${{ needs.release-collector.result }}
          - **Action**: Draft release created
          - **Link**: [Collector Releases](https://github.com/SumoLogic/sumologic-otel-collector/releases)

          ### Packaging
          - **RCâ†’Stable Promotion**: ${{ needs.promote-packaging-to-stable.result }}
          - **Draft Release**: ${{ needs.release-packaging.result }}
          - **Link**: [Packaging Releases](https://github.com/SumoLogic/sumologic-otel-collector-packaging/releases)

          ### Containers
          - **RCâ†’Stable + Draft**: ${{ needs.release-containers.result }}
          - **Link**: [Containers Releases](https://github.com/SumoLogic/sumologic-otel-collector-containers/releases)
          ---
          
          ## ðŸ“ Next Steps
          
          1. **Publish [Collector Release](https://github.com/SumoLogic/sumologic-otel-collector/releases) FIRST** âš ï¸
             - Add upstream OT versions & changelog â†’ Publish (triggers `post-release.yml` for package tags)
          2. **Verify** [post-release workflow](https://github.com/SumoLogic/sumologic-otel-collector/actions/workflows/post-release.yml) created package tags
          3. **Publish** [Packaging Release](https://github.com/SumoLogic/sumologic-otel-collector-packaging/releases)
          4. **Publish** [Containers Release](https://github.com/SumoLogic/sumologic-otel-collector-containers/releases)
          EOF

      - name: Check for failures
        if: |
          needs.validate-and-discover.result == 'failure' ||
          needs.release-collector.result == 'failure' ||
          needs.promote-packaging-to-stable.result == 'failure' ||
          needs.release-packaging.result == 'failure' ||
          needs.release-containers.result == 'failure'
        run: |
          echo "::error::One or more release steps failed. Check the summary above."
          exit 1
