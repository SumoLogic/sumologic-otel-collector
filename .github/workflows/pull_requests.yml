name: PRs checks

on:
  pull_request:
    branches:
      - '**'

jobs:

  markdownlint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'
      - name: Install markdownlint
        run: gem install mdl
      - name: Markdownlint check
        run: make markdownlint

  yamllint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.3.4
      - name: Install yamllint
        run: pip install yamllint
      - name: yamllint
        run: make yamllint

  test:
    name: Test
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        go: [ '1.16.4', '1.17.0-beta1' ]
        # TODO:
        # when telegraf dependency gets removed for any reason merge MacOS
        # builds with other OSes. Until this happens test/build it separately
        # due to CGO_RELATED cross compilation issues.
        # Exemplar failed workflow:
        # https://github.com/SumoLogic/sumologic-otel-collector/runs/2963259368
        arch_os: [ 'linux_amd64' ]
    steps:
      - uses: actions/checkout@v2.3.4

      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
          stable: 'false'

      # As described in
      # https://github.com/mvdan/github-actions-golang#how-do-i-set-up-caching-between-builds
      - uses: actions/cache@v2
        with:
          path: |
            /home/runner/go/pkg/mod
            /home/runner/.cache/go-build
          key: ${{matrix.arch_os}}-go-pkg-${{matrix.go}}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{matrix.arch_os}}-go-pkg-${{matrix.go}}-

      - name: Run tests
        run: make gotest

  test-mac:
    name: Test
    runs-on: macos-latest
    strategy:
      matrix:
        # TODO: Don't test on 1.17.0-beta1 for now due to a strange bug in 1.17
        # causing SIGSEGV: segmentation violation on darwin when testing
        # telegrafreceiver.
        #
        # Possibly related to https://github.com/golang/go/issues/46080
        # Failed CI build https://github.com/SumoLogic/sumologic-otel-collector/runs/2972810531
        go: [ '1.16.4'  ]
        arch_os: [ 'darwin_amd64' ]
    steps:
      - uses: actions/checkout@v2.3.4

      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
          stable: 'false'

      # As described in
      # https://github.com/mvdan/github-actions-golang#how-do-i-set-up-caching-between-builds
      - uses: actions/cache@v2
        with:
          path: |
            /home/runner/go/pkg/mod
            /home/runner/.cache/go-build
          key: ${{matrix.arch_os}}-go-pkg-${{matrix.go}}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{matrix.arch_os}}-go-pkg-${{matrix.go}}-

      - name: Run tests
        run: make gotest

  lint:
    name: Lint (golangci-lint)
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        go: [ '1.16.4', '1.17.0-beta1' ]
        arch_os: [ 'linux_amd64' ]
    steps:
      - uses: actions/checkout@v2.3.4

      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
          stable: 'false'

      # As described in
      # https://github.com/mvdan/github-actions-golang#how-do-i-set-up-caching-between-builds
      - uses: actions/cache@v2
        with:
          path: |
            /home/runner/go/pkg/mod
            /home/runner/.cache/go-build
          key: ${{matrix.arch_os}}-go-lint-${{matrix.go}}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{matrix.arch_os}}-go-lint-${{matrix.go}}-

      - name: Install golangci-lint
        run: make install-golangci-lint

      - name: Run golangci-lint
        run: make golint

  build:
    name: Build
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        go: [ '1.17.0-beta1' ]
        arch_os: [ 'linux_amd64' ]
    steps:
      - uses: actions/checkout@v2.3.4

      - name: Fetch current branch
        run: ./ci/fetch_current_branch.sh

      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
          stable: 'false'

      # As described in
      # https://github.com/mvdan/github-actions-golang#how-do-i-set-up-caching-between-builds
      - uses: actions/cache@v2
        with:
          path: |
            /home/runner/go/pkg/mod
            /home/runner/.cache/go-build
          key: ${{matrix.arch_os}}-go-${{matrix.go}}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{matrix.arch_os}}-go-${{matrix.go}}-

      - name: Install opentelemetry-collector-builder
        run: make install
        working-directory: ./otelcolbuilder

      - name: Build
        run: make otelcol-sumo-${{matrix.arch_os}}
        working-directory: ./otelcolbuilder

      - name: Show included modules
        working-directory: ./otelcolbuilder/cmd
        run: |
          go version -m otelcol-sumo-${{matrix.arch_os}} | \
          grep -E "/(receiver|exporter|processor|extension)/"

      - name: Store binary as action artifact
        uses: actions/upload-artifact@v2
        with:
          name: otelcol-sumo-${{matrix.arch_os}}
          path: ./otelcolbuilder/cmd/otelcol-sumo-${{matrix.arch_os}}
          if-no-files-found: error

  build-mac:
    name: Build
    runs-on: macos-latest
    strategy:
      matrix:
        go: [ '1.17.0-beta1' ]
        # TODO:
        # when telegraf dependency gets removed for any reason merge MacOS
        # builds with other OSes. Until this happens test/build it separately
        # due to CGO_RELATED cross compilation issues.
        # Exemplar failed workflow:
        # https://github.com/SumoLogic/sumologic-otel-collector/runs/2963259368
        arch_os: [ 'darwin_amd64' ]
    steps:
      - uses: actions/checkout@v2.3.4

      - name: Fetch current branch
        run: ./ci/fetch_current_branch.sh

      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
          stable: 'false'

      # As described in
      # https://github.com/mvdan/github-actions-golang#how-do-i-set-up-caching-between-builds
      - uses: actions/cache@v2
        with:
          path: |
            /home/runner/go/pkg/mod
            /home/runner/.cache/go-build
          key: ${{matrix.arch_os}}-go-${{matrix.go}}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{matrix.arch_os}}-go-${{matrix.go}}-

      - name: Install opentelemetry-collector-builder
        run: make install
        working-directory: ./otelcolbuilder

      - name: Build
        run: make otelcol-sumo-${{matrix.arch_os}}
        working-directory: ./otelcolbuilder

      - name: Show included modules
        working-directory: ./otelcolbuilder/cmd
        run: |
          go version -m otelcol-sumo-${{matrix.arch_os}} | \
          grep -E "/(receiver|exporter|processor|extension)/"

      - name: Store binary as action artifact
        uses: actions/upload-artifact@v2
        with:
          name: otelcol-sumo-${{matrix.arch_os}}
          path: ./otelcolbuilder/cmd/otelcol-sumo-${{matrix.arch_os}}
          if-no-files-found: error
